---
title: "6 Практика"
author: "gleb.plokhikh@yandex.ru"
format: 
  md:
    output-file: README.md
---

## Цель работы

  1. Закрепить навыки исследования данных журнала Windows Active Directory
  2. Изучить структуру журнала системы Windows Active Directory
  3. Закрепить практические навыки использования языка программирования R для
обработки данных
  4. Закрепить знания основных функций обработки данных экосистемы tidyverse
языка R



## Исходные данные

1. Программное обеспечение Windows 11
2. Rstudio Desktop
3. Интерпретатор языка R 4.5.1
4. Программный пакет dplyr
 
## План

1. Подготовка данных для анализа 
2. Анализ датасета
3. Оформление отчета

## Шаги:

### Подготовка данных

1.Импортируйте данных
```{r}
library(jsonlite)
library(xml2)
library(rvest)
library(dplyr)
library(tidyr)
library(purrr)

src_url <- "https://storage.yandexcloud.net/iamcth-data/dataset.tar.gz"
tmp_tar <- "ad_logs.tar.gz"

download.file(src_url, tmp_tar, mode = "wb", quiet = TRUE)

tar_contents <- untar(tmp_tar, list = TRUE)
json_path <- tar_contents[grep("\\.json$", tar_contents)]

tmp_dir <- tempdir()
untar(tmp_tar, files = json_path, exdir = tmp_dir)

full_json <- file.path(tmp_dir, json_path)

json_conn <- file(full_json, open = "r")
logs_raw <- stream_in(json_conn)
cat("Строк импортировано:", nrow(logs_raw), "\n")

events_url <- "https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor"
html_doc <- read_html(events_url)
event_ref <- html_table(html_doc, fill = TRUE)[[1]]
```

2.Приведение данных к “аккуратной” форме:
```{r}
logs_prepared <- logs_raw %>%
mutate(
time = as.POSIXct(`@timestamp`, format = "%Y-%m-%dT%H:%M:%OSZ"),
across(where(is.character), ~ifelse(. == "", NA, .))
)

cat("Строк:", nrow(logs_prepared), "Колонок:", ncol(logs_prepared), "\n")
```

3.Просмотрите общую структуру данных с помощью функции glimpse()
```{r}
glimpse(logs_prepared)
glimpse(event_ref)
```


### Анализ данных

1.Разворачивание вложенных датафреймов:
```{r}
nested_cols <- names(logs_prepared)[map_lgl(logs_prepared, is.data.frame)]

for (cl in nested_cols) {
logs_prepared <- unnest(logs_prepared, all_of(cl), names_sep = "_")
}
```

2.Удаление колонок с единичными значениями:
```{r}
drop_cols <- c()

for (nm in names(logs_prepared)) {
x <- logs_prepared[[nm]]
if (!is.list(x) && !is.data.frame(x)) {
uniq <- unique(na.omit(x[seq_len(min(1000, length(x)))]))
if (length(uniq) <= 1) drop_cols <- c(drop_cols, nm)
}
}

logs_prepared <- select(logs_prepared, -any_of(drop_cols))

cat("Колонок удалено:", length(drop_cols), "\n")
cat("Осталось колонок:", ncol(logs_prepared), "\n")
```

3.Подсчет количества уникальных хостов:
```{r}
host_total <- logs_prepared %>%
distinct(winlog_computer_name) %>%
nrow()

cat("Уникальных хостов:", host_total, "\n")
```

4.Подготовка справочника Windows Event_ID:
```{r}
events_clean <- event_ref %>%
rename(
winlog_event_id = `Current Windows Event ID`,
event_desc = `Event Summary`
) %>%
mutate(
winlog_event_id = as.integer(winlog_event_id),
event_desc = as.character(event_desc)
)

glimpse(events_clean)
```

5.Определение событий с высоким и средним уровнем важности:
```{r}
sev_high <- logs_prepared %>% filter(log_level == "error")
sev_mid <- logs_prepared %>% filter(log_level == "warning")

cat("События высокого уровня:", nrow(sev_high), "\n")
cat("События среднего уровня:", nrow(sev_mid), "\n")
cat("Всего:", nrow(sev_high) + nrow(sev_mid), "\n")
```

## Результат

  В ходе работы мы изучили структуру логов Windows AD, освоили методы их анализа с помощью R, а также закрепили навыки использования tidyverse для обработки данных.

## Вывод

  Используя пакет dplyr, удалось провести анализ активности в домене Windows, выявить события с разной степенью важности и научиться работать с журналами системы.
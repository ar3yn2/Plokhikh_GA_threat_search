---
title: "6 Практика"
author: "gleb.plokhikh@yandex.ru"
format: 
  md:
    output-file: README.md
---

## Цель работы

  1. Закрепить навыки исследования данных журнала Windows Active Directory
  2. Изучить структуру журнала системы Windows Active Directory
  3. Закрепить практические навыки использования языка программирования R для
обработки данных
  4. Закрепить знания основных функций обработки данных экосистемы tidyverse
языка R



## Исходные данные

1. Программное обеспечение Windows 11
2. Rstudio Desktop
3. Интерпретатор языка R 4.5.1
4. Программный пакет dplyr
 
## План

1. Подготовка данных для анализа 
2. Анализ датасета

## Шаги:

## Подготовка данных

1.Импорт данных

```{r}
library(jsonlite)
library(dplyr)
library(tidyr)
library(purrr)
library(rvest)
library(xml2)
```

2.Скачать архив

```{r}
archive_url <- "https://storage.yandexcloud.net/iamcth-data/dataset.tar.gz"
archive_file <- "ad_logs_downloaded.tar.gz"
download.file(archive_url, archive_file, mode = "wb")
```

3.Содержимое и извлечение JSON

```{r}
contents <- untar(archive_file, list = TRUE)
json_file <- contents[grep("\\.json$", contents)]
tmp_extract <- tempdir()
untar(archive_file, files = json_file, exdir = tmp_extract)
json_full <- file.path(tmp_extract, json_file)
```

4.Чтение JSON

```{r}
raw_logs <- stream_in(file(json_full))
cat("Количество записей в исходных логах:", nrow(raw_logs), "\n")
```

## 2.Аккуратная форма:
1.

```{r}
logs_clean <- raw_logs %>%
mutate(
event_ts = as.POSIXct(`@timestamp`, format="%Y-%m-%dT%H:%M:%OSZ"),
across(where(is.character), ~na_if(., ""))
)
```

2.Вложенные столбцы

```{r}
nested_cols <- names(logs_clean)[map_lgl(logs_clean, is.data.frame)]
logs_flat <- logs_clean
for (col in nested_cols) {
logs_flat <- unnest_wider(logs_flat, all_of(col), names_sep = "_")
}
```

3.Убираем колонки с одним значением

```{r}
logs_flat <- logs_flat %>% select(where(~ n_distinct(., na.rm = TRUE) > 1))
glimpse(logs_flat)
```

## 3.Справочник Windows Event_ID
1.

```{r}
events_page <- read_html("https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor")
events_table <- html_table(events_page, fill = TRUE)[[1]]
events_dict <- events_table %>%
rename(
event_id = `Current Windows Event ID`,
importance = `Potential Criticality`,
description = `Event Summary`
) %>%
mutate(
event_id = as.integer(event_id),
importance = as.character(importance),
description = as.character(description)
)
glimpse(events_dict)
```

## 4.Анализ данных

1.Количество уникальных хостов

```{r}
host_count <- logs_flat %>% distinct(winlog_computer_name) %>% nrow()
cat("Количество уникальных хостов:", host_count, "\n")
```

2.Объединение с описанием событий

```{r}
logs_annot <- logs_flat %>%
left_join(events_dict, by = c("winlog_event_id" = "event_id"))
```

3.Отбор событий по уровню важности

```{r}
critical_events <- logs_annot %>% filter(importance == "High")
medium_events <- logs_annot %>% filter(importance == "Medium")
cat("События высокого уровня:", nrow(critical_events), "\n")
cat("События среднего уровня:", nrow(medium_events), "\n")
cat("Всего критичных и средних событий:", nrow(critical_events) + nrow(medium_events), "\n")
```

## Результат

  В ходе работы мы изучили структуру логов Windows AD, освоили методы их анализа с помощью R, а также закрепили навыки использования tidyverse для обработки данных.

## Вывод

  Используя пакет dplyr, удалось провести анализ активности в домене Windows, выявить события с разной степенью важности и научиться работать с журналами системы.
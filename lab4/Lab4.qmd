---
title: "4ПР Исследование метаданных DNS трафика"
subtitle: "lab4"
author: "gleb.plokhikh@yandex.ru"
format: 
  md:
    output-file: README.md
---

## Цель работы

1.  Зекрепить практические навыки использования языка программирования R для обработки данных
2.  Закрепить знания основных функций обработки данных экосистемы tidyverse языка R
3.  Закрепить навыки исследования метаданных DNS трафика

## Исходные данные

1.  Программное обеспечение ОС Windows 11
2.  RStudio
3.  Интерпретатор языка R 4.1

## План

1. Импорт данных и распаковка.
2. Настройка корректной структуры столбцов.
3. Преобразование типов данных.
4. Анализ участников обмена.
5. Определение топ-10 активных IP и доменов.
6. Статистический анализ интервалов времени.
7. Поиск IP с периодической активностью.
8. Определение геолокации топ-доменов.

## Шаги:

1\. Загрузка и подготовка данных

```{r}
library(readr)
library(dplyr)
library(stringr)
library(httr)
library(jsonlite)
library(purrr)
library(knitr)

temp_dir <- tempdir()
zip_file <- file.path(temp_dir, "dns_archive.zip")
download.file(
  url = "https://storage.yandexcloud.net/dataset.ctfsec/dns.zip",
  destfile = zip_file,
  mode = "wb"
)
unzip(zip_file, exdir = temp_dir)
log_paths <- list.files(temp_dir, pattern = "\\.log$", full.names = TRUE)
```

2\. Настройка структуры данных

```{r}
dns_columns <- c(
"ts","uid","src_ip","src_port","dst_ip","dst_port",
"protocol","trans_id","query","qclass","qclass_name",
"qtype","qtype_name","rcode","rcode_name","AA","TC",
"RD","RA","Z","answers","TTLs","rejected"
)

dns_tbl <- read_delim(
log_paths[1],
delim = "\t",
col_names = dns_columns,
comment = "#",
na = c("", "NA", "-"),
trim_ws = TRUE,
show_col_types = FALSE
) %>% as_tibble()
```

3\. Преобразование данные в столбцах в нужный формат

```{r}
dns_tbl_clean <- dns_tbl %>%
transmute(
timestamp = as.POSIXct(ts, origin="1970-01-01"),
src_ip,
src_port = as.numeric(src_port),
dst_ip,
dst_port = as.numeric(dst_port),
protocol,
trans_id = as.numeric(trans_id),
query,
qclass = as.numeric(qclass),
qtype = as.numeric(qtype),
rcode = as.numeric(rcode)
)
```

4\. Участники информационного обмена

```{r}
all_ips <- unique(c(dns_tbl_clean$src_ip, dns_tbl_clean$dst_ip))
total_participants <- length(all_ips)
internal_ips <- all_ips[
  grepl("^(10\\.|192\\.168\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.)", all_ips)
]
external_ips <- setdiff(all_ips, internal_ips)
ratio_internal_external <- length(internal_ips) / length(external_ips)
external_ips <- setdiff(all_ips, internal_ips)
ratio_internal_external <- length(internal_ips)/length(external_ips)
```

5\. Топ-10 активных участников и доменов

```{r}
top_ips <- dns_tbl_clean %>%
count(src_ip, sort = TRUE) %>%
slice_head(n = 10)
top_domains <- dns_tbl_clean %>%
count(query, sort = TRUE) %>%
slice_head(n = 10)
```

6\. Статистика интервалов между запросами для топ-доменов

```{r}
top_domain_data <- dns_tbl_clean %>%
filter(query %in% top_domains$query) %>%
arrange(query, timestamp)
domain_stats <- map_dfr(top_domains$query, function(dom) {
df <- filter(top_domain_data, query == dom)
times <- as.numeric(df$timestamp)
if(length(times) > 1){
diffs <- diff(times)
tibble(
Domain = dom,
Min = min(diffs),
Q1 = quantile(diffs, 0.25),
Median = median(diffs),
Mean = mean(diffs),
Q3 = quantile(diffs, 0.75),
Max = max(diffs))}
})
```

8\. Поиск IP с периодической активностью

```{r}
suspicious_activity <- map_dfr(top_domains$query, function(dom) {
df <- filter(dns_tbl_clean, query == dom)
ips <- unique(df$src_ip)
map_dfr(ips, function(ip){
subdf <- filter(df, src_ip == ip)
if(nrow(subdf) >= 5){
ts_sorted <- sort(as.numeric(subdf$timestamp))
intervals <- diff(ts_sorted)
avg_int <- mean(intervals)
sd_int <- sd(intervals)
tibble(
src_ip = ip,
domain = dom,
requests = nrow(subdf),
avg_interval = avg_int,
std_dev = sd_int,
is_periodic = sd_int < 0.5*avg_int
) %>% filter(is_periodic)}})
})
```

8\. Определение геолокации для топ-доменов

```{r}
domain_ips <- dns_tbl_clean %>%
filter(query %in% top_domains$query) %>%
group_by(query) %>%
summarise(ip_address = first(dst_ip), .groups = "drop")
get_geo <- function(ip){
if (grepl("^(10\\.|192\\.168\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.)", ip))
return(tibble(country="Private", city="Private", isp="Private"))
res <- tryCatch({
r <- GET(paste0("http://ip-api.com/json/", ip))
if(status_code(r)==200){
info <- fromJSON(content(r,"text"))
if(info$status=="success")
tibble(country=info$country, city=info$city, isp=info$isp)
else tibble(country="Unknown", city="Unknown", isp="Unknown")
} else tibble(country="API error", city="API error", isp="API error")
}, error=function(e) tibble(country="Error", city="Error", isp="Error"))
Sys.sleep(1)
res
}
geo_info <- map_dfr(domain_ips$ip_address, get_geo) %>%
bind_cols(domain_ips)
```

## Оценка результата

В рамках практческой работы была исследована подозрительная сетевая активность во внутренней сети организации. Были восстановлены недостающие метаданные и подготовлены ответы на вопросы.

## Вывод

Таким мобразом в ходе работы мы зекрепили практические навыки использования языка программирования R для обработки данных, знания основных функций обработки данных экосистемы tidyverse языка R и навыки исследования метаданных DNS трафика

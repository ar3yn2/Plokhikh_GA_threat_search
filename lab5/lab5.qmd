---
title: "5 Пр"
author: "gleb.plokhikh@yandex.ru"
format: 
  md:
    output-file: README.md
---

## Цель работы

  1. Получить знания о методах исследования радиоэлектронной обстановки.
  2. Понять работу Wi-Fi сетей на канальном и сетевом уровнях модели OSI
  3. Закрепить практические навыки использования языка программирования R для
обработки данных
  4. Научиться применять функции tidyverse для работы с данными.


## Исходные данные

1. Программное обеспечение Windows 11
2. Rstudio Desktop
3. Интерпретатор языка R 4.5.1
4. dplyr
5. Логи tcpdump и airodump-ng для анализа беспроводных сетей  
       
 
## План

1. Подготовка данных для анализа 
2. Анализ точек доступа
3. Анализ данных клиентов


## Шаги:  

## Подготовка данных


1. Импортирование данных
```{r}
libs <- c("tidyverse","lubridate","stringr","curl")
installed <- libs %in% installed.packages()[,"Package"]
if(any(!installed)) install.packages(libs[!installed])

library(tidyverse)
library(lubridate)
library(stringr)
library(curl)
```
2. Загрузка данных

```{r}
url <- "https://storage.yandexcloud.net/dataset.ctfsec/P2_wifi_data.csv"
tmp <- tempfile(fileext = ".csv")
curl::curl_download(url, tmp)
```

3. Считываем весь CSV в R
```{r}
lines <- read_lines(tmp)
divider <- which(str_detect(lines, "Station MAC"))
ap_data <- read_csv(tmp, n_max = divider - 2, col_names = FALSE)
client_data <- read_csv(tmp, skip = divider - 1, col_names = FALSE)
```

4. Преобразование датасетов в аккуратный вид

```{r}
ap_clean <- ap_data |>
rename(
bssid = X1,
first_seen = X2,
last_seen = X3,
channel = X4,
speed = X5,
privacy = X6,
cipher = X7,
auth = X8,
signal = X9,
beacons = X10,
iv = X11,
lan = X12,
id_len = X13,
essid = X14
) |>
mutate(
first_seen = as_datetime(first_seen),
last_seen = as_datetime(last_seen),
across(c(channel,speed,signal,beacons,iv,id_len), as.numeric)
)
```

```{r}
clients_clean <- client_data |>
rename(
mac = X1,
first_seen = X2,
last_seen = X3,
signal = X4,
packets = X5,
assoc_bssid = X6,
probe = X7
) |>
mutate(
first_seen = as_datetime(first_seen),
last_seen = as_datetime(last_seen),
signal = as.numeric(signal),
packets = as.numeric(packets)
) |>
filter(!is.na(mac), mac != "")
```

5. Просмотр структуры данных

```{r}
glimpse(ap_clean)
glimpse(clients_clean)
```

## Анализ точек доступа
1. Определение небезопасных точек

```{r}
open_ap <- ap_clean |>
filter(privacy == "OPN") |>
arrange(desc(signal)) |>
select(bssid, essid, privacy, signal)
print(open_ap)
cat("Всего открытых точек:", nrow(open_ap), "\n")
```

2. Производители oui

```{r}
get_oui <- function(mac) str_replace_all(substr(mac,1,8), ":", "-")
ap_vendors <- ap_clean |>
mutate(vendor = get_oui(bssid)) |>
count(vendor, name = "num") |>
arrange(desc(num))
print(head(ap_vendors, 10))
```

3. WPA3 точки

```{r}
wpa3_ap <- ap_clean |>
filter(str_detect(toupper(coalesce(auth,"")), "WPA3") |
str_detect(toupper(coalesce(privacy,"")), "WPA3") |
str_detect(toupper(coalesce(cipher,"")), "WPA3")) |>
arrange(desc(signal)) |>
select(bssid, essid, privacy, auth, cipher, signal)
print(wpa3_ap)
```

4. Сессии точек доступа

```{r}
ap_sessions <- ap_clean |>
arrange(bssid, first_seen) |>
group_by(bssid) |>
mutate(gap_min = as.numeric(difftime(first_seen, lag(last_seen, default = first(first_seen)), units="mins")),
session_id = cumsum(gap_min > 45 | row_number()==1)) |>
group_by(bssid, session_id) |>
summarise(start = min(first_seen), end = max(last_seen), .groups="drop") |>
mutate(duration_min = as.numeric(difftime(end, start, units="mins"))) |>
arrange(desc(duration_min))
head(ap_sessions,10)
```

## Анализ клиентов
1. Производители клиентов

```{r}
clients_clean <- clients_clean |>
mutate(oui = substr(mac,1,8))
clients_clean |>
count(oui, name = "num") |> arrange(desc(num)) |> head(10)
```

2. Нерандомизированные MAC

```{r}
clients_nonrnd <- clients_clean |>
filter(!substr(mac,2,2) %in% c("2","6","a","A","e","E"))
nrow(clients_nonrnd)
```

3. Кластеры probe-запросов

```{r}
probe_stats <- clients_clean |>
filter(!is.na(probe), probe != "") |>
separate_rows(probe, sep=",") |>
group_by(mac, probe) |>
summarise(first_seen = min(first_seen),
last_seen = max(last_seen),
mean_signal = mean(signal, na.rm=TRUE),
sd_signal = sd(signal, na.rm=TRUE),
.groups="drop")
probe_stats
```

4. Стабильность сигнала
```{r}
probe_stats <- probe_stats |>
mutate(stability = 1 / (sd_signal + 1e-6)) |>
arrange(desc(stability))
probe_stats |> slice(1)
```

## Оценка результата

1.Проанализированы точки доступа и клиенты сети.
2.Выявлены открытые и WPA3 AP.
3.Определены производители и стабильность сигналов клиентов.


## Вывод

  Таким образом, мы научились провоить анализ журналов с использованием программного пакета dplyr.
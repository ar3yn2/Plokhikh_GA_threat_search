---
title: "Исследование информации о состоянии беспроводных сетей"
author: "gleb.plokhikh@yandex.ru"
format: 
  md:
    output-file: README.md
---

## Цель работы

  1. Получить знания о методах исследования радиоэлектронной обстановки.
  2. Составить представление о механизмах работы Wi-Fi сетей на канальном и
сетевом уровне модели OSI.
  3. Закрепить практические навыки использования языка программирования R для
обработки данных
  4. Закрепить знания основных функций обработки данных экосистемы tidyverse
языка R


## Исходные данные

1. Программное обеспечение Windows 11 Pro
2. Rstudio Desktop
3. Интерпретатор языка R 4.5.1
4. Программный пакет dplyr
5. Журналы программных средств анализа беспроводных сетей – tcpdump и airodump-ng 
       
 
## План

1. Подготовка данных для анализа 
2. Анализ точек доступа
3. Анализ данных клиентов
4. Оформление отчета


## Шаги:  

### Подготовка данных


1. Импортирование данных
```{r}
options(repos = c(CRAN = "https://mirror.truenetwork.ru/CRAN/"))
packages <- c("tidyverse","lubridate","stringr","curl")
missing <- packages[!(packages %in% installed.packages()[,"Package"])]
if(length(missing)) install.packages(missing)
library(tidyverse)
library(lubridate)
library(stringr)
library(curl)
```
2. Загрузка данных

```{r}
dataset_url <- "https://storage.yandexcloud.net/dataset.ctfsec/P2_wifi_data.csv"
tmp_file <- tempfile(fileext=".csv")
curl::curl_download(dataset_url, tmp_file, quiet = TRUE)
raw_data <- read_csv(tmp_file, skip = 1, col_names = FALSE)
divider <- which(raw_data$X1 == "Station MAC")
```

3. Создание таблиц AP и клиентов

```{r}
ap_raw <- raw_data[2:(divider[1]-1), ]
clients_raw <- raw_data[divider[1]:nrow(raw_data), ]  # исправлено
ap_raw <- ap_raw[rowSums(is.na(ap_raw) | ap_raw=="") < ncol(ap_raw), ]
clients_raw <- clients_raw[rowSums(is.na(clients_raw) | clients_raw=="") < ncol(clients_raw), ]
clients_raw <- clients_raw[, 1:7]
ap_cols <- c("bssid","first_seen","last_seen","chan","speed","privacy","cipher","auth","signal","beacon_count","iv","lan","id_len","essid","key_type")
client_cols <- c("mac","first_seen","last_seen","signal","pkt","assoc_bssid","probe")
names(ap_raw) <- ap_cols[1:ncol(ap_raw)]
names(clients_raw) <- client_cols[1:ncol(clients_raw)]
```

4. Преобразование типов и очистка

```{r}
wifi_ap <- ap_raw %>%
  filter(!is.na(bssid), bssid!="" , !is.na(essid), essid!="") %>%
  mutate(
    first_seen = as.POSIXct(first_seen, format="%Y-%m-%d %H:%M:%S"),
    last_seen = as.POSIXct(last_seen, format="%Y-%m-%d %H:%M:%S"),
    chan = as.numeric(chan),
    speed = as.numeric(speed),
    signal = as.numeric(signal),
    beacon_count = as.numeric(beacon_count),
    iv = as.numeric(iv),
    id_len = as.numeric(id_len)
  )

wifi_clients <- clients_raw[-1, ] %>%
  filter(!is.na(mac), mac!="" , mac!="Station MAC") %>%
  mutate(
    first_seen = as.POSIXct(first_seen, format="%Y-%m-%d %H:%M:%S"),
    last_seen = as.POSIXct(last_seen, format="%Y-%m-%d %H:%M:%S"),
    signal = as.numeric(signal),
    pkt = as.numeric(pkt)
  )
```

5. Просмотр структуры данных

```{r}
glimpse(wifi_ap)
glimpse(wifi_clients)
```

### Анализ точек доступа
1. Определение небезопасных точек OPN

```{r}
open_ap <- wifi_ap %>%
filter(privacy=="OPN") %>%
arrange(desc(signal)) %>%
select(bssid, essid, privacy, signal, chan)

if(nrow(open_ap) > 0){
print(open_ap)
cat("Всего небезопасных точек:", nrow(open_ap), "\n")
cat("Процент от всех:", round(100*nrow(open_ap)/nrow(wifi_ap),1), "%\n")
} else cat("Небезопасные точки отсутствуют\n")
```

2. Производители AP

```{r}
extract_oui <- function(mac){ ifelse(!is.na(mac)&mac!="", str_replace_all(substr(mac,1,8),":","-"), NA_character_) }

ap_vendor <- wifi_ap %>%
mutate(vendor = extract_oui(bssid)) %>%
select(bssid, essid, vendor, privacy, signal)

vendor_count <- ap_vendor %>%
count(vendor, name="count") %>%
arrange(desc(count))

print(head(vendor_count,10))
cat("Уникальных производителей:", n_distinct(ap_vendor$vendor, na.rm=TRUE), "\n")
```

3. Точки с WPA3

```{r}
wpa3_ap <- wifi_ap %>%
filter(str_detect(toupper(coalesce(auth,"")),"WPA3") |
str_detect(toupper(coalesce(privacy,"")),"WPA3") |
str_detect(toupper(coalesce(cipher,"")),"WPA3")) %>%
arrange(desc(signal)) %>%
select(bssid, essid, privacy, auth, cipher, signal)

if(nrow(wpa3_ap)>0){
print(wpa3_ap)
cat("Всего WPA3 AP:", nrow(wpa3_ap), "\n")
}else cat("WPA3 устройства не найдены\n")
```

4. Длительность сессий AP

```{r}
ap_sessions <- wifi_ap %>%
group_by(bssid) %>%
arrange(first_seen) %>%
mutate(gap_m = as.numeric(difftime(first_seen, lag(last_seen, default=first(first_seen)),"mins")),
sess_id = cumsum(gap_m>45 | row_number()==1)) %>%
group_by(bssid,sess_id) %>%
summarise(essid=first(essid),
start=min(first_seen),
end=max(last_seen),
.groups="drop") %>%
mutate(duration_min=as.numeric(difftime(end,start,"mins"))) %>%
arrange(desc(duration_min)) %>%
select(bssid, essid, start, end, duration_min)

print(head(ap_sessions,10))
cat("Максимальная длительность:", round(max(ap_sessions$duration_min),1), "мин\n")
```

5. Топ-10 по скорости

```{r}
fast_ap <- wifi_ap %>%
filter(!is.na(speed), speed>0) %>%
arrange(desc(speed)) %>%
slice(1:10) %>%
select(bssid, essid, speed, chan, signal)

print(fast_ap)
cat("Максимальная скорость:", max(fast_ap$speed), "Mbps\n")
```

6. Beacon-трафик

```{r}
beacon_stats <- wifi_ap %>%
mutate(hours=as.numeric(difftime(last_seen, first_seen, "hours")),
rate=ifelse(hours>0, beacon_count/hours, beacon_count)) %>%
filter(!is.na(rate), hours>0, rate>0) %>%
arrange(desc(rate)) %>%
select(bssid, essid, beacon_count, hours, rate, chan)

print(head(beacon_stats,10))
cat("Максимальная частота beacon:", round(max(beacon_stats$rate),1), "в час\n")
```

### Анализ клиентов
1. Производители клиентов

```{r}
client_vendor <- wifi_clients %>%
mutate(oui=substr(mac,1,8)) %>%
select(mac, oui, probe) %>%
distinct()

print(head(client_vendor,10))
cat("Уникальных производителей клиентов:", n_distinct(client_vendor$oui), "\n")
```

2. Нерандомизированные MAC

```{r}
clients_nonrnd <- wifi_clients %>%
mutate(second=substr(mac,2,2),
is_rnd=second %in% c("2","6","a","e","A","E")) %>%
filter(!is_rnd) %>%
arrange(desc(pkt)) %>%
select(mac, first_seen, last_seen, signal, pkt, probe)

print(head(clients_nonrnd,10))
cat("Количество нерандомизированных:", nrow(clients_nonrnd), "\n")
cat("Процент:", round(100*nrow(clients_nonrnd)/nrow(wifi_clients),1), "%\n")
```

3. Кластеризация probe-запросов

```{r}
probe_stats <- wifi_clients %>%
filter(!is.na(probe), probe!="") %>%
group_by(mac, probe) %>%
summarise(mean_signal=mean(signal,na.rm=TRUE),
sd_signal=sd(signal,na.rm=TRUE),
n_obs=n(),
first_seen=min(first_seen),
last_seen=max(last_seen),
.groups="drop") %>%
arrange(sd_signal)

probe_stats
```

4. Стабильность сигнала
```{r}
probe_stats <- probe_stats %>%
mutate(stability_score=1/(sd_signal+1e-6))

top_cluster <- probe_stats %>%
arrange(desc(stability_score)) %>%
slice(1)

top_cluster
```

## Оценка результата

  В результате лабораторной работы мы получили знания о методах исследования радиоэлектронной обстановки, составили представление о механизмах работы Wi-Fi сетей, закрепили практические навыки использования языка программирования R и знания основных функций обработки данных экосистемы tidyverse.


## Вывод

  Таким образом, мы научились провоить анализ журналов с использованием программного пакета dplyr.